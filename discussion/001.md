<!-- Comment 001 - 2025-12-26T03:27:18+01:00 -->

# Implementation Plan

## Design

### Schema Tag

```yaml
define:
  users:
    id: !logd-auto-id .[nullable(string)]
    name: .[string]
```

The `!logd-auto-id` tag on a field implies:
1. Parent array is keyed by this field (replaces `KeyedArrays` config)
2. If field is missing/null on patch, server generates an ID

### ID Generation

Monotonic IDs derived from commit number + index:

```go
func AutoID(commit int64, index int) string {
    buf := make([]byte, 8, 16)
    binary.BigEndian.PutUint64(buf, uint64(commit))
    buf = binary.AppendUvarint(buf, uint64(index))
    return encodeRadix32(buf) // alphabet: a-z0-5
}
```

- **Monotonic**: IDs sort lexicographically in commit order
- **Compact**: Base-32 encoding keeps strings short
- **Stateless**: No separate counter to persist - derived from commit

## Implementation Steps

### Step 1: Schema parsing for auto-id fields

**File: `api/schema.go`**

```go
type AutoIDField struct {
    Path  string // kpath to the array (e.g., "users", "orders.items")
    Field string // field name (e.g., "id")
}

type Schema struct {
    AutoIDFields []AutoIDField
}
```

**File: `api/schema_parse.go`** (NEW)

Parse Tony schema for `!logd-auto-id` tags, build Schema.

### Step 2: Radix-32 ID encoding

**File: `storage/autoid/autoid.go`** (NEW)

```go
const alphabet = "abcdefghijklmnopqrstuvwxyz012345"

func Generate(commit int64, index int) string
```

### Step 3: Auto-id injection in commit flow

**File: `storage/tx/auto_id.go`** (NEW)

```go
// Input:  path="users", data={name: "Alice"}, commit=42
// Output: path="users(aaaaaaq)", data={id: "aaaaaaq", name: "Alice"}
func InjectAutoIDs(patches []*PatcherData, schema *api.Schema, commit int64) error
```

### Step 4: Wire into tx coordinator

**File: `storage/tx/coord.go`**

After commit assigned, before merge:
```go
commit, err := ops.NextCommit()
if schema := ops.Schema(); schema != nil {
    if err := InjectAutoIDs(state.PatcherData, schema, commit); err != nil {
        return err
    }
}
mergedPatch, err := MergePatches(state.PatcherData)
```

### Step 5: CommitOps interface extension

Add `Schema() *api.Schema` to CommitOps interface.

### Step 6: Server config

Add `SchemaFile` to config, load and parse on startup.

## Files

| File | Change |
|------|--------|
| `api/schema.go` | Rewrite Schema struct |
| `api/schema_parse.go` | NEW: Parse Tony schema |
| `storage/autoid/autoid.go` | NEW: Radix-32 ID generation |
| `storage/tx/auto_id.go` | NEW: InjectAutoIDs |
| `storage/tx/coord.go` | Call InjectAutoIDs |
| `storage/tx/tx.go` | Add Schema() to CommitOps |
| `storage/commit_ops.go` | Implement Schema() |
| `server/config.go` | Add SchemaFile |

